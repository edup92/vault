---
- name: vaultwarden
  hosts: all
  gather_facts: true
  become: true

  tasks:
    - name: Installations
      block:
        - name: Update APT cache
          apt:
            update_cache: true
        - name: Basic Packages
          apt:
            name:
              - software-properties-common
              - gnupg
              - curl
              - ca-certificates
              - nano
              - unzip
            state: present
        - name: Prepare Docker repo GPG
          file:
            path: /etc/apt/keyrings/docker.asc
            state: touch
            mode: "0644"
        - name: Download Docker GPG key
          get_url:
            url: https://download.docker.com/linux/ubuntu/gpg
            dest: /etc/apt/keyrings/docker.asc
            mode: "0644"
        - name: Configure Docker repository
          copy:
            dest: /etc/apt/sources.list.d/docker.list
            mode: "0644"
            content: |
              deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_facts['lsb']['codename'] }} stable
        - name: Update apt cache
          apt:
            update_cache: true
        - name: Install Docker
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present
            update_cache: true

    - name: Create vaultwarden user and directories
      block:
        - name: Create vaultwarden user
          user:
            name: vaultwarden
            shell: /bin/bash
            home: /opt/vaultwarden
            create_home: no
            groups: docker
            append: yes
            state: present
          register: vaultwarden_user
        - name: Create vaultwarden directories
          file:
            path: "{{ item.path }}"
            state: directory
            owner: vaultwarden
            group: vaultwarden
            mode: "{{ item.mode }}"
          loop:
            - { path: "/opt/vaultwarden", mode: "0700" }
            - { path: "/opt/vaultwarden/docker", mode: "0755" }
            - { path: "/opt/vaultwarden/env", mode: "0755" }
            - { path: "/opt/vaultwarden/ssl", mode: "0755" }
            - { path: "/opt/vaultwarden/data", mode: "0755" }

    - name: Generate self signed SSL
      block:
        - name: Generate self-signed SSL certificate
          command: >
            openssl req -x509 -nodes -days 365 -newkey rsa:2048
            -keyout /opt/vaultwarden/ssl/privkey.pem
            -out /opt/vaultwarden/ssl/fullchain.pem
            -subj "/C=ES/ST=Madrid/L=Madrid/O=vaultwarden/CN={{ dns_record }}"
          args:
            creates: "/opt/vaultwarden/ssl/fullchain.pem"
        - name: Set SSL files permissions
          file:
            path: "{{ item }}"
            owner: vaultwarden
            group: vaultwarden
            mode: "0644"
          loop:
            - /opt/vaultwarden/ssl/privkey.pem
            - /opt/vaultwarden/ssl/fullchain.pem

    - name: Create vaultwarden config files
      block:
        - name: Ensure cookie secret file exists
          copy:
            dest: /opt/vaultwarden/docker/oauth_cookie_secret.txt
            content: "{{ lookup('pipe', 'openssl rand -base64 48 | tr -dc A-Za-z0-9 | head -c 32') }}"
            owner: vaultwarden
            group: vaultwarden
            mode: "0600"
            force: no
        - name: Read cookie secret from remote file
          slurp:
            src: /opt/vaultwarden/docker/oauth_cookie_secret.txt
          register: cookie_secret_raw
        - name: Set fact for cookie secret
          set_fact:
            oauth_cookie_secret: "{{ cookie_secret_raw.content | b64decode }}"
        - name: Generate oauth proxy allowed accounts
          copy:
            dest: /opt/vaultwarden/env/allowed_emails.txt
            content: "{{ admin_email }}"
            owner: vaultwarden
            group: vaultwarden
            mode: "0644"
        - name: Generate vaultwarden env
          copy:
            dest: "/opt/vaultwarden/env/vaultwarden.env"
            content: |
              DOMAIN=https://{{ dns_record }}
              ROCKET_PORT=80
              ROCKET_ADDRESS=0.0.0.0
              SIGNUPS_ALLOWED=false
              INVITATIONS_ALLOWED=false
              WEBSOCKET_ENABLED=true
              WEB_VAULT_ENABLED=true
              ADMIN_TOKEN={{ admin_pass }}
              TZ=Europe/Madrid
              SMTP_HOST={{ smtp_host }}
              SMTP_FROM={{ smtp_username }}
              SMTP_PORT={{ smtp_port }}
              SMTP_SECURITY={{ smtp_security }}
              SMTP_USERNAME={{ smtp_username }}
              SMTP_PASSWORD={{ smtp_password }}
            owner: vaultwarden
            group: vaultwarden
            mode: "0600"
        - name: Generate Oauth Proxy env
          copy:
            dest: "/opt/vaultwarden/env/oauth-proxy.env"
            content: |
              OAUTH2_PROXY_PROVIDER=google
              OAUTH2_PROXY_CLIENT_ID={{ oauth_client_id }}
              OAUTH2_PROXY_CLIENT_SECRET={{ oauth_client_secret }}
              OAUTH2_PROXY_COOKIE_SECRET={{ oauth_cookie_secret }}
              OAUTH2_PROXY_REDIRECT_URL=https://{{ dns_record }}/oauth2/callback
              OAUTH2_PROXY_AUTHENTICATED_EMAILS_FILE=/etc/oauth2_proxy/allowed_emails.txt
              OAUTH2_PROXY_COOKIE_DOMAIN={{ dns_record }}
              OAUTH2_PROXY_TLS_CERT_FILE=/ssl/fullchain.pem
              OAUTH2_PROXY_TLS_KEY_FILE=/ssl/privkey.pem
              OAUTH2_PROXY_HTTP_ADDRESS=0.0.0.0:443
              OAUTH2_PROXY_PASS_USER_HEADERS=true
              OAUTH2_PROXY_SET_XAUTHREQUEST=true
              OAUTH2_PROXY_SKIP_PROVIDER_BUTTON=true
              OAUTH2_PROXY_UPSTREAMS=http://vaultwarden:80
              OAUTH2_PROXY_COOKIE_SECURE=true
              OAUTH2_PROXY_PROXY_HEADERS=X-Forwarded-Proto:https
              OAUTH2_PROXY_SKIP_AUTH_ROUTES=^/api,^/icons,^/alive
            owner: vaultwarden
            group: vaultwarden
            mode: "0600"
 
    - name: Docker configurations
      block:
        - name: Generate docker-compose.yml
          copy:
            dest: "/opt/vaultwarden/docker/docker-compose.yml"
            content: |-
              services:
                vaultwarden:
                  image: vaultwarden/server:latest
                  container_name: vaultwarden
                  restart: always
                  volumes:
                    - ../data:/data
                  env_file:
                    - ../env/vaultwarden.env
                  expose:
                    - "80"
                  networks:
                    - internal

                oauth2-proxy:
                  image: quay.io/oauth2-proxy/oauth2-proxy:latest
                  container_name: oauth2-proxy
                  restart: always
                  volumes:
                    - ../env/allowed_emails.txt:/etc/oauth2_proxy/allowed_emails.txt:ro
                    - ../ssl/fullchain.pem:/ssl/fullchain.pem
                    - ../ssl/privkey.pem:/ssl/privkey.pem
                  env_file:
                    - ../env/oauth-proxy.env
                  networks:
                    - internal
                  ports:
                    - "443:443"

              networks:
                internal:
                  driver: bridge
            owner: vaultwarden
            group: vaultwarden
            mode: "0644"
        - name: Create systemd service for Vaultwarden
          copy:
            dest: "/etc/systemd/system/vaultwarden-server.service"
            content: |
              [Unit]
              Description=vaultwarden Docker Compose
              Requires=docker.service
              After=docker.service

              [Service]
              Type=oneshot
              RemainAfterExit=yes
              ExecStart=/usr/bin/docker compose -f /opt/vaultwarden/docker/docker-compose.yml up -d
              ExecStop=/usr/bin/docker compose -f /opt/vaultwarden/docker/docker-compose.yml down
              TimeoutStartSec=0

              [Install]
              WantedBy=multi-user.target
            mode: "0644"
        - name: Enable and start Vaultwarden service
          systemd:
            name: vaultwarden-server
            enabled: true
            state: restarted
            daemon_reload: true