---
- name: vaultwarden
  hosts: all
  gather_facts: true
  become: true

  tasks:
    - name: Installations
      block:
        - name: Install prerequisites
          apt:
            name:
              - ca-certificates
              - curl
              - gnupg
              - lsb-release
              - nano
              - unzip
            state: present
            update_cache: true
        - name: Ensure keyrings directory exists
          file:
            path: /etc/apt/keyrings
            state: directory
            mode: "0755"
        - name: Download Docker GPG key (ASCII)
          get_url:
            url: https://download.docker.com/linux/ubuntu/gpg
            dest: /tmp/docker.gpg
            mode: "0644"
        - name: Convert GPG key to dearmored format
          command: gpg --dearmor -o /etc/apt/keyrings/docker.gpg /tmp/docker.gpg
          args:
            creates: /etc/apt/keyrings/docker.gpg
        - name: Configure Docker APT repo
          copy:
            dest: /etc/apt/sources.list.d/docker.list
            content: |
              deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_facts['lsb']['codename'] }} stable
            mode: "0644"
        - name: Update APT cache
          apt:
            update_cache: true
        - name: Install Docker
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present
            update_cache: true

    - name: Create vaultwarden user and directories
      block:
        - name: Create vaultwarden user
          user:
            name: vaultwarden
            shell: /bin/bash
            home: /opt/vaultwarden
            create_home: no
            groups: docker
            append: yes
            state: present
          register: vaultwarden_user
        - name: Create vaultwarden directories
          file:
            path: "{{ item.path }}"
            state: directory
            owner: vaultwarden
            group: vaultwarden
            mode: "{{ item.mode }}"
          loop:
            - { path: "/opt/vaultwarden", mode: "0700" }
            - { path: "/opt/vaultwarden/docker", mode: "0755" }
            - { path: "/opt/vaultwarden/env", mode: "0755" }
            - { path: "/opt/vaultwarden/data", mode: "0755" }
            - { path: "/opt/vaultwarden/data/tailscale", mode: "0755" }

    - name: Create vaultwarden config files
      block:
        - name: Generate vaultwarden env
          copy:
            dest: "/opt/vaultwarden/env/vaultwarden.env"
            content: |
              DOMAIN=https://{{ dns_record }}
              ROCKET_PORT=80
              ROCKET_ADDRESS=0.0.0.0
              SIGNUPS_ALLOWED=false
              INVITATIONS_ALLOWED=false
              WEBSOCKET_ENABLED=true
              WEB_VAULT_ENABLED=true
              ADMIN_TOKEN={{ admin_pass }}
              TZ=Europe/Madrid
              SMTP_HOST={{ smtp_host }}
              SMTP_FROM={{ smtp_username }}
              SMTP_PORT={{ smtp_port }}
              SMTP_SECURITY={{ smtp_security }}
              SMTP_USERNAME={{ smtp_username }}
              SMTP_PASSWORD={{ smtp_password }}
            owner: vaultwarden
            group: vaultwarden
            mode: "0600"
 
    - name: Docker configurations
      block:
        - name: Generate docker-compose.yml
          copy:
            dest: "/opt/vaultwarden/docker/docker-compose.yml"
            content: |-
              services:
                tailscale:
                  image: tailscale/tailscale:stable
                  container_name: tailscale
                  hostname: vault
                  restart: always
                  cap_add:
                    - NET_ADMIN
                    - NET_RAW
                  devices:
                    - /dev/net/tun:/dev/net/tun
                  volumes:
                    - /opt/vaultwarden/data/tailscale:/var/lib/tailscale
                  environment:
                    TS_AUTHKEY: "{{ tailscale_key }}"
                    TS_STATE_DIR: /var/lib/tailscale
                    TS_HOSTNAME: vault

                vaultwarden:
                  image: vaultwarden/server:latest
                  container_name: vaultwarden
                  restart: always
                  volumes:
                    - ../data:/data
                  env_file:
                    - ../env/vaultwarden.env
                  network_mode: "service:tailscale"
                  depends_on:
                    - tailscale
            owner: vaultwarden
            group: vaultwarden
            mode: "0644"
        - name: Create systemd service for Vaultwarden
          copy:
            dest: "/etc/systemd/system/vaultwarden-server.service"
            content: |
              [Unit]
              Description=vaultwarden Docker Compose
              Requires=docker.service
              After=docker.service

              [Service]
              Type=oneshot
              RemainAfterExit=yes
              ExecStart=/usr/bin/docker compose -f /opt/vaultwarden/docker/docker-compose.yml up -d
              ExecStop=/usr/bin/docker compose -f /opt/vaultwarden/docker/docker-compose.yml down
              TimeoutStartSec=0

              [Install]
              WantedBy=multi-user.target
            mode: "0644"
        - name: Enable and start Vaultwarden service
          systemd:
            name: vaultwarden-server
            enabled: true
            state: restarted
            daemon_reload: true 