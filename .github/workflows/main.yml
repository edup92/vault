name: main
on:
  workflow_dispatch:
permissions:
  contents: read
  issues: write

jobs:

  validate-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets exist
        env:
          VARS_JSON: ${{ secrets.VARS_JSON }}
          SERVICE_ACCOUNT: ${{ secrets.SERVICE_ACCOUNT }}
        run: |
          for s in VARS_JSON SERVICE_ACCOUNT; do
            if [ -z "${!s}" ]; then
              echo "Error: Missing required secret: $s"
              exit 1
            fi
          done
          echo "All required secrets exist"
      - name: Validate VARS_JSON schema
        env:
          VARS: ${{ secrets.VARS_JSON }}
        run: |
          jq -e '
            (.gcloud_project_id   | type=="string") and
            (.gcloud_region       | type=="string") and
            (.cf_token            | type=="string") and
            (.cf_accountid        | type=="string") and
            (.project_name        | type=="string") and
            (.dns_domain          | type=="string") and
            (.dns_record          | type=="string") and
            (.admin_email         | type=="string") and
            (.admin_pass          | type=="string") and
            (.smtp_host           | type=="string") and
            (.smtp_security       | type=="string") and
            (.smtp_username       | type=="string") and
            (.smtp_password       | type=="string") and
            (.oauth_client_id     | type=="string") and
            (.oauth_client_secret | type=="string") and
            (.smtp_port           | type=="number") and
            (.allowed_countries   | type=="array")
          ' <<<"$VARS" >/dev/null \
          || { echo "Error: VARS_JSON schema invalid"; exit 1; }
          echo "VARS_JSON schema valid"
      - name: Validate SERVICE_ACCOUNT schema
        env:
          SA: ${{ secrets.SERVICE_ACCOUNT }}
        run: |
          jq -e '
            (.type | type=="string") and
            (.project_id | type=="string") and
            (.private_key_id | type=="string") and
            (.private_key | type=="string") and
            (.client_email | type=="string") and
            (.client_id | type=="string") and
            (.auth_uri | type=="string") and
            (.token_uri | type=="string") and
            (.auth_provider_x509_cert_url | type=="string") and
            (.client_x509_cert_url | type=="string") and
            (.universe_domain | type=="string")
          ' <<<"$SA" >/dev/null \
          || { echo "Error: SERVICE_ACCOUNT schema invalid"; exit 1; }
          echo "SERVICE_ACCOUNT schema valid"

  prepare-backend:
    runs-on: ubuntu-latest
    needs: validate-secrets
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.SERVICE_ACCOUNT }}
      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: "${{ fromJSON(secrets.VARS_JSON).gcloud_project_id }}"
      - name: Create or check state bucket
        env:
          VARS: ${{ secrets.VARS_JSON }}
        run: |
          PROJECT_NAME=$(echo "$VARS" | jq -r '.project_name')
          GCP_PROJECT=$(echo "$VARS" | jq -r '.gcloud_project_id')
          GCP_REGION=$(echo "$VARS" | jq -r '.gcloud_region')
          BUCKET_NAME="${PROJECT_NAME}-bucket-tfstate"
          if gsutil ls -p "$GCP_PROJECT" "gs://$BUCKET_NAME" >/dev/null 2>&1; then
            echo "Bucket already exists: $BUCKET_NAME, skipping creation"
          else
            gsutil mb -p "$GCP_PROJECT" -l "$GCP_REGION" "gs://$BUCKET_NAME"
            gcloud storage buckets update gs://$BUCKET_NAME --uniform-bucket-level-access
            gsutil versioning set on "gs://$BUCKET_NAME"
            echo "Bucket created with versioning: $BUCKET_NAME"
          fi
      - name: Create TF Backend
        env:
          VARS: ${{ secrets.VARS_JSON }}
        run: |
          PROJECT_NAME=$(echo "$VARS" | jq -r '.project_name')
          BUCKET_NAME="${PROJECT_NAME}-bucket-tfstate"
          tee backend.tf > /dev/null <<EOF
          terraform {
            backend "gcs" {
              bucket = "$BUCKET_NAME"
              prefix = ""
            }
          }
          EOF
          echo "backend.tf file generated successfully"
      - name: Upload backend.tf
        uses: actions/upload-artifact@v4
        with:
          name: tfbackend
          path: backend.tf

  prepare-tfvars:
    runs-on: ubuntu-latest
    needs: validate-secrets
    steps:
      - name: Generate terraform.auto.tfvars.json
        env:
          VARS: ${{ secrets.VARS_JSON }}
        run: |
          echo "Storing keys into terraform.auto.tfvars.json:"
          echo "$VARS" | jq -r 'keys[]' | sed "s/^/ - /"
          printf '%s\n' "$VARS" > terraform.auto.tfvars.json
      - name: Upload terraform.auto.tfvars.json
        uses: actions/upload-artifact@v4
        with:
          name: tfvars
          path: terraform.auto.tfvars.json

  tf-plan:
    runs-on: ubuntu-latest
    needs:
      - prepare-backend
      - prepare-tfvars
    timeout-minutes: 5
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Download backend.tf
        uses: actions/download-artifact@v4
        with:
          name: tfbackend
          path: .
      - name: Download terraform.auto.tfvars.json
        uses: actions/download-artifact@v4
        with:
          name: tfvars
          path: .
      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.SERVICE_ACCOUNT }}
      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
      - name: Terraform init
        run: terraform init -input=false
      - name: Terraform plan
        run: terraform plan -input=false -no-color -out=tfplan
      - name: Generate visual plan
        run: terraform show -no-color tfplan > tfplan_visual
      - name: Upload plan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-artifacts
          path: |
            tfplan
            tfplan_visual

  approbal:
    runs-on: ubuntu-latest
    needs:
      - tf-plan
    steps:
      - name: Download tfplan artifacts
        uses: actions/download-artifact@v4
        with:
          name: tfplan-artifacts
          path: .
      - name: Await Manual Approval
        timeout-minutes: 5
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          minimum-approvals: 1
          approvers: ${{ github.actor }}
          issue-title: "Manual Approval Required for Terraform Apply"
          issue-body-file-path: tfplan_visual

  tf-apply:
    runs-on: ubuntu-latest
    needs:
      - approbal
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Download tfplan artifacts
        uses: actions/download-artifact@v4
        with:
          name: tfplan-artifacts
          path: .
      - name: Download backend.tf
        uses: actions/download-artifact@v4
        with:
          name: tfbackend
          path: .
      - name: Download terraform.auto.tfvars.json
        uses: actions/download-artifact@v4
        with:
          name: tfvars
          path: .
      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.SERVICE_ACCOUNT }}
      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
      - name: Install Ansible
        run: sudo apt-get install -y ansible
      - name: Terraform init
        run: terraform init -input=false
      - name: Terraform apply
        run: terraform apply -auto-approve tfplan
