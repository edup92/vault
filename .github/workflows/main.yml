name: main
on:
  workflow_dispatch:
permissions:
  contents: read
  issues: write

jobs:

  prepare-vars:
    runs-on: ubuntu-latest
    outputs:
      vars_export: ${{ steps.export.outputs.vars_export }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Check VARS secret exists
        env:
          VARS_JSON: ${{ secrets.VARS_JSON }}
        run: |
          if [ -z "$VARS_JSON" ]; then
            echo "Error: Secret VARS is missing or empty"
            exit 1
          fi
      - name: Export dynamic JSON output
        id: export
        env:
          VARS_JSON: ${{ secrets.VARS_JSON }}
        run: |
          delimiter="EOF_$(openssl rand -hex 8)"
          {
            echo "vars_export<<$delimiter"
            echo "$VARS_JSON"
            echo "$delimiter"
          } >> "$GITHUB_OUTPUT"

  prepare-backend:
    runs-on: ubuntu-latest
    needs: prepare-vars
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.SERVICE_ACCOUNT }}
      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ fromJSON(needs.prepare-vars.outputs.vars_export).gcloud_project_id }}
      - name: Create or check state bucket
        env:
          VARS: ${{ needs.prepare-vars.outputs.vars_export }}
        run: |
          BUCKET_NAME=$(echo "$VARS" | jq -r '.project_name')-bucket-tfstate
          GCP_PROJECT=$(echo "$VARS" | jq -r '.gcloud_project_id')
          GCP_REGION=$(echo "$VARS" | jq -r '.gcloud_region')
          if gsutil ls -p "$GCP_PROJECT" "gs://$BUCKET_NAME" >/dev/null 2>&1; then
            echo "Bucket already exists: $BUCKET_NAME, skipping"
          else
            gsutil mb -p "$GCP_PROJECT" -l "$GCP_REGION" "gs://$BUCKET_NAME"
            gcloud storage buckets update gs://$BUCKET_NAME --uniform-bucket-level-access
            gsutil versioning set on "gs://$BUCKET_NAME"
            echo "Bucket created successfully with versioning enabled: $BUCKET_NAME"
          fi
      - name: Create TF Backend
        env:
          VARS: ${{ needs.prepare-vars.outputs.vars_export }}
        run: |
          BUCKET_NAME=$(echo "$VARS" | jq -r '.project_name')-bucket-tfstate
          tee backend.tf > /dev/null <<EOF
          terraform {
            backend "gcs" {
              bucket = "$BUCKET_NAME"
              prefix = ""
            }
          }
          EOF
      - name: Upload backend.tf artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend
          path: backend.tf

  terraform-plan:
    runs-on: ubuntu-latest
    needs: [prepare-vars, prepare-backend]
    timeout-minutes: 5
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Download backend.tf artifact
        uses: actions/download-artifact@v4
        with:
          name: backend
          path: .
      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.SERVICE_ACCOUNT }}
      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
      - name: Build dynamic terraform -var arguments
        id: tfvars
        env:
          VARS: ${{ needs.prepare-vars.outputs.vars_export }}
        run: |
          VAR_ARGS=""
          for key in $(echo "$VARS" | jq -r 'keys[]'); do
            value=$(echo "$VARS" | jq -r --arg k "$key" '.[$k]')
            VAR_ARGS="$VAR_ARGS -var=\"$key=$value\""
          done
          echo "vars=$VAR_ARGS" >> "$GITHUB_OUTPUT"
      - name: Terraform init
        run: terraform init -input=false
      - name: Terraform plan
        run: terraform plan -input=false -no-color ${{ steps.tfvars.outputs.vars }} -out=tfplan
      - name: Generate visual plan (tfplan_visual)
        run: terraform show -no-color tfplan > tfplan_visual
      - name: Upload tfplan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-artifacts
          path: |
            tfplan
            tfplan_visual

  terraform-apply:
    runs-on: ubuntu-latest
    needs: terraform-plan
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Download tfplan artifacts
        uses: actions/download-artifact@v4
        with:
          name: tfplan-artifacts
          path: .
      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3
      - name: Install Ansible
        run: sudo apt-get install -y ansible
      - name: Await Manual Approval (5 min timeout)
        id: approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          minimum-approvals: 1
          approvers: ${{ github.actor }}
          timeout-minutes: 5
          issue-title: "Manual Approval Required for Terraform Apply"
          issue-body-file-path: tfplan_visual
      - name: Terraform apply
        run: terraform apply -auto-approve tfplan
